<!--web module Reference from: http://bl.ocks.org/mbostock/3883245 -->
<!--web module Reference from: http://bl.ocks.org/mbostock/3884955#index.html -->
<!--show/hide line Reference from: http://bl.ocks.org/d3noob/e99a762017060ce81c76 -->
<html>
<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
	<script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
</head>
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.tick line {
	opacity: 0.2;
}

</style>
<body>
</body>
<script>

//begin--line chart feature setting

var margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// reserve for expressing
//     label of each line
var reserv_w = 30;

var x = d3.time.scale()
    .range([0, width - reserv_w]);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category20();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
	.tickSize(-height,0);

var yAxis = d3.svg.axis()
    .scale(y)
	.ticks(5,"$")
    .orient("left")
	.tickSize(-width,0);

var line = d3.svg.line()
    .x(function(d) { return x(d.Date); })
    .y(function(d) { return y(d.price); });

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
//end--line chart feature setting


// connect to firebase db
var firebaseRef = new Firebase("https://ikdde-team6.firebaseio.com/vegetable_data/");

// store data from firebase and drawing charts
firebaseRef.on("value", function(snapshot) {

	var data = [];

	// get all vegetable name
	var name = d3.keys(snapshot.val()).filter(function(name) { return name != 'default'});

	console.log(name);

	snapshot.forEach( function(child) {
		child.forEach( function(grandChild) {
			data.push( {
				cate: child.key(),
				name: grandChild.key(),
				value: grandChild.val(),
				opacity: +0
			});
		});
	});

	// reconstruct(rebuild) date
	data.forEach( function(v) {
		v.value = d3.values(v.value);
		v.value.forEach( function(e) {
			// creat_new element
			e.Date = new Date(e.date.year,e.date.month,e.date.day);
				console.log(e.price);
		});
	});

	console.log(data);

	// set color domain by vegetable name
	//     vegetable name --mapping--> specific color
	color.domain(data.map(function(v) { return v.name}));


	// set x domain by range from min of date to max of date
	//     x invoked in xAxis
	x.domain([
		d3.min(data, function(v) { return d3.min(v.value, function(d) { return d.Date});}),
		d3.max(data, function(v) { return d3.max(v.value, function(d) { return d.Date});})
	]);


	// find max y, if y_max is NaN(no line display), set as default 50
	var y_max = d3.max(
			data.filter( function(v) { return v.opacity===1;}),
			function(v) { return d3.max(v.value, function(d) { return d.price; }); }
		);
	y_max = isNaN(y_max)? +50: y_max;

	// set y domain by range from min of date to max of date
	//     y invoked in yAxis
	y.domain([
		0,
		y_max
	]);

	// append x axis by feature xAxis
	var gxAxis = svg.append("g")
					.attr("class","x axis")
					.attr("transform","translate(0," + height + ")")
					.call(xAxis);
	

	// append y axis by feature yAxis
	var gyAxis = svg.append("g")
					.attr("class","y axis")
					.call(yAxis)

	// append y axis label
	.append("text")

		// from horizental to vertical
		.attr("transform","rotate(-90)")

		// the distant to y axis
		.attr("y",6)

		.attr("dy", ".71em")
		.style("text-anchor", "end")
		.text("Price/Weight ($/kg)");


	// add all g
	var vg = svg.selectAll(".city")
				.data(data)
				.enter()
			.append("g")
				.attr("class","city")
				.attr("id", function(v) { return 'tag_'+v.name; })
				.style("opacity", function(v) { return v.opacity; });

	// add path by feature "line" under each ".city"
	vg.append("path")
		.attr("class","line")
		.attr("id", function(v) { return "tag_"+v.name; })
		.attr("d", function(v) { return line(v.value); })
		.style("stroke", function(v) { return color(v.name); })

	// append label for each line
	vg.append("text")
		.datum(function(d) { return {name: d.name, value: d.value[d.value.length - 1]}; })
		.attr("class","vglabel")
		.attr("id", function(v) { return "tag_"+v.name; })
		.attr("transform", function(d) { return "translate(" + x(d.value.Date) + "," + y(d.value.price) + ")"; })
		.attr("x", 3)
		.attr("dy", ".35em")
		.text(function(d) { return d.name; })

		// can be modiy by css
		.style("font-size","20px")
		.style("font-weight","bold")
		.style("stroke", "#000")
		.style("fill", function(v) { return color(v.name); });

	var label_W = width/data.length; 

	//console.log(data);

	// add label for control line display
	// Reference from http://bl.ocks.org/d3noob/e99a762017060ce81c76
	/*
	svg.append("g")
		.selectAll(".choose")
		.data(data)
		.enter()
	.append("text")
		.attr("class","choose")
		.attr("x", function(v) { return (label_W/2)+v.id*label_W; })
		.attr("y", function(v) { return height+(margin.bottom/2)+5; })
		.style("fill", function(v) { return color(v.name);})
		.on("click", function (v) { click(v); } )
		.text(function(v) { return v.name;});

	*/

	d3.select("body")
	.append("div")
		.selectAll(".vginput")
		.data(data)
	.enter()
	.append("label")
		.style("color", function(v) { return color(v.name); })
		.text(function(v) { return " |" + v.name; })
	.append("input")
		.attr("type","checkbox")
		.property("position", "absolute")
		.property("left", function(v) { return v.id*10+"px"; })
		.on("change", function(v) {
			this.checked ^ true;
			click(v);
		})
	;

	// for toggle event
	function click(v) {
		var duration_time = 800;

		v.opacity ^= 1;

		var y_max = d3.max(data.filter( function(v) { return v.opacity===1; }), function(v) {return d3.max(v.value, function(d) { return d.price; }); });
		y_max = isNaN(y_max)?+50:y_max;
		y.domain([
			0,
			y_max
		]);

		d3.select(".y.axis")
			.transition()
			.duration(duration_time)
			.call(yAxis);

		data.forEach( function(v) {
				d3.select(".line#tag_"+v.name)
					.transition()
					.duration(duration_time)
					.attr("d", function(v) { return line(v.value); });

				d3.select(".city#tag_"+v.name)
					.transition()
					.duration(duration_time)
					.style("opacity", function(v) { return v.opacity; });

				d3.select(".vglabel#tag_"+v.name)
					.transition()
					.duration(duration_time)
					.attr("transform", function(v) { ;return "translate(" + x(v.value.Date) + "," + y(v.value.price) + ")"; });

		});
	}
});

</script>
</html>
